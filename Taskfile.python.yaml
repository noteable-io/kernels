version: 3

vars:
  NBL_PYTHON_VERSION: 3.9
  IDENTIFIER: base

tasks:
  core:build:
    desc: Build the Python 3.x image
    cmds:
      - >-
        docker build python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}} \
          --build-arg "NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}" \
          --build-arg "BASE_IMAGE={{.BASE_IMAGE}}" \
          --tag "local/kernel-python-{{.NBL_PYTHON_VERSION}}-{{.IDENTIFIER}}:dev"

  base:copy-root-files:
    desc: Copy files from the root of the repository to the build directories
    cmds:
      - cp apt-install python/base/{{.NBL_PYTHON_VERSION}}/apt-install
    generates:
      - python/base/{{.NBL_PYTHON_VERSION}}/apt-install

  base:copy-files:
    desc: Copy files from the language-level directory to the build directories
    deps: [base:copy-root-files]
    cmds:
      - cp python/{{.IDENTIFIER}}/Aptfile python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/Aptfile
      - cp python/{{.IDENTIFIER}}/run.sh python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/run.sh
      - cp python/{{.IDENTIFIER}}/secrets_helper.py python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/secrets_helper.py
    generates:
      - python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/Aptfile
      - python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/run.sh
      - python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/secrets_helper.py

  base:pyenv:install:
    desc: Install the specified version of Python using pyenv
    cmds:
      - pyenv install -s {{.NBL_PYTHON_VERSION}}

  base:pyenv:virtualenv:
    desc: Create a new virtual environment using pyenv
    deps: [base:pyenv:install]
    cmds:
      - pyenv virtualenv {{.NBL_PYTHON_VERSION}} py{{.NBL_PYTHON_VERSION}} || true

  base:deps:install-pip-tools:
    desc: Install Python dependencies
    deps: [base:pyenv:virtualenv]
    cmds:
      - $(pyenv root)/versions/py{{.NBL_PYTHON_VERSION}}/bin/python -m pip install pip-tools==6.13.0

  base:deps:copy-requirements:
    desc: Copy identifier-level requirements.in files to the version-level build directories
    cmds:
      - mkdir -p python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}
      - cp python/{{.IDENTIFIER}}/requirements.in python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/requirements.in
    generates:
      - python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/requirements.in

  # Base image
  base:lock-dependencies:
    desc: Uses pip-tools compile to lock Python dependency versions for a specific build identifier and version
    deps: [base:deps:install-pip-tools, base:deps:copy-requirements]
    cmds:
      # specifically looks at the python/<ident>/<version>/<version>.requirements.in file, not the generic requirements.in files
      - $(pyenv root)/versions/py{{.NBL_PYTHON_VERSION}}/bin/python -m piptools compile --resolver=backtracking --output-file python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/requirements.txt python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/{{.NBL_PYTHON_VERSION}}.requirements.in
    generates:
      - python/{{.IDENTIFIER}}/{{.NBL_PYTHON_VERSION}}/requirements.txt

  base:build:
    desc: Build the Python 3.x base image after copying required files
    cmds:
      # these have to be done in order, so we can't use deps
      - task python:base:copy-files IDENTIFIER=base NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}
      - task python:core:build IDENTIFIER=base NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  # Base GPU image
  base-gpu:lock-dependencies:
    desc: Lock Python dependencies for GPU builds using pip-compile
    deps: [base:lock-dependencies]
    cmds:
      - task python:base:lock IDENTIFIER=base-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  base-gpu:build:
    desc: Build the Python 3.x image with GPU support after copying required files
    cmds:
      - task python:base:copy-files IDENTIFIER=base-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}
      - task python:core:build IDENTIFIER=base-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  # Datascience image
  datascience:lock-dependencies:
    desc: Lock Python dependencies for datascience builds using pip-compile
    cmds:
      - task python:base:lock-dependencies IDENTIFIER=datascience NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  datascience:build:
    desc: Build the Python 3.x image with datascience packages
    cmds:
      - task python:core:build IDENTIFIER=datascience NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}} BASE_IMAGE=local/kernel-python-{{.NBL_PYTHON_VERSION}}-base:dev

  # Datascience GPU image
  datascience-gpu:lock-dependencies:
    desc: Lock Python dependencies for datascience builds using pip-compile
    cmds:
      - task python:base:lock-dependencies IDENTIFIER=datascience-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  datascience-gpu:build:
    desc: Build the Python 3.x image with datascience packages and GPU support
    cmds:
      - task python:core:build IDENTIFIER=datascience-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}} BASE_IMAGE=local/kernel-python-{{.NBL_PYTHON_VERSION}}-base:dev

  # Noteable image
  noteable:copy-files:
    desc: Copy files from the `python/noteable` directory to the build directories
    deps: [base:deps:copy-requirements]

  noteable:lock-dependencies:
    desc: Lock Python dependencies for Noteable builds using pip-compile
    cmds:
      - task python:base:lock-dependencies IDENTIFIER=noteable NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  noteable:build:
    desc: Build the Python 3.x image with "Noteable feature"-related packages (SQL, git integration, DEX, etc)
    cmds:
      - task python:noteable:copy-files IDENTIFIER=noteable NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}
      - task python:core:build IDENTIFIER=noteable NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}} BASE_IMAGE=local/kernel-python-{{.NBL_PYTHON_VERSION}}-datascience:dev

  # Noteable GPU image
  noteable-gpu:lock-dependencies:
    desc: Lock Python dependencies for Noteable builds using pip-compile
    cmds:
      - task python:base:lock-dependencies IDENTIFIER=noteable-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}

  noteable-gpu:build:
    desc: Build the Python 3.x image with "Noteable feature"-related packages (SQL, git integration, DEX, etc) and GPU support
    cmds:
      - task python:noteable:copy-files IDENTIFIER=noteable-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}}
      - task python:core:build IDENTIFIER=noteable-gpu NBL_PYTHON_VERSION={{.NBL_PYTHON_VERSION}} BASE_IMAGE=local/kernel-python-{{.NBL_PYTHON_VERSION}}-datascience-gpu:dev
